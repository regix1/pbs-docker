# Custom Dockerfile that adds subscription nag removal on top of base PBS image
ARG BASE_IMAGE
FROM ${BASE_IMAGE}

# Copy BOTH versions - the old one AND a new one that won't be cached
COPY dockerfiles/pbs/pbs-post-install.sh /etc/proxmox-backup-default/pbs-post-install.sh
COPY dockerfiles/pbs/pbs-post-install.sh /etc/proxmox-backup-default/pbs-post-install.sh.new
RUN chmod +x /etc/proxmox-backup-default/pbs-post-install.sh && \
    chmod +x /etc/proxmox-backup-default/pbs-post-install.sh.new

# Add the runit service for subscription removal
COPY dockerfiles/runit/proxmox-remove-subscription /runit/proxmox-remove-subscription
RUN chmod +x /runit/proxmox-remove-subscription/run

# Ensure all runit services are executable
RUN find /runit -name "run" -type f -exec chmod +x {} \;
RUN find /runit -name "finish" -type f -exec chmod +x {} \; 2>/dev/null || true

# Set environment variable defaults for subscription removal
ENV PBS_ENTERPRISE=no \
    PBS_NO_SUBSCRIPTION=yes \
    DISABLE_SUBSCRIPTION_NAG=yes