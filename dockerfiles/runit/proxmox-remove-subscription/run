#!/bin/sh
exec 2>&1

SERVICE_NAME="proxmox-remove-subscription"
MARKER_FILE="/var/lib/proxmox-backup/.subscription-nag-disabled"
DONE_FILE="/var/run/proxmox-remove-subscription.done"

# ALWAYS create subscription file first to prevent base64 error
echo "[$SERVICE_NAME] Creating subscription file..."
mkdir -p /etc/proxmox-backup
cat > /etc/proxmox-backup/subscription << 'EOF'
{
    "status": "active",
    "serverid": "00000000000000000000000000000000",
    "checktime": "1735689600",
    "key": "pbs-no-subscription",
    "validuntil": "2099-12-31",
    "productname": "Proxmox Backup Server",
    "regdate": "2025-01-01 00:00:00",
    "nextduedate": "2099-12-31"
}
EOF
chmod 600 /etc/proxmox-backup/subscription

# Check if we've been told to stop by the finish script
if [ -f "$DONE_FILE" ]; then
    echo "[$SERVICE_NAME] Service marked as complete, sleeping..."
    exec sleep infinity
fi

echo "[$SERVICE_NAME] Starting service..."

# Check if already completed
if [ -f "$MARKER_FILE" ]; then
    echo "[$SERVICE_NAME] Subscription nag already removed, exiting..."
    exit 0
fi

# Wait for PBS API to be ready (max 30 seconds)
echo "[$SERVICE_NAME] Waiting for PBS API to start..."
for i in $(seq 1 30); do
    if curl -k -s https://localhost:8007/ > /dev/null 2>&1; then
        echo "[$SERVICE_NAME] PBS API is ready"
        break
    fi
    sleep 1
done

# Run the post-install script
POST_INSTALL_SCRIPT="/etc/proxmox-backup-default/pbs-post-install.sh"
if [ -f "$POST_INSTALL_SCRIPT" ]; then
    echo "[$SERVICE_NAME] Running PBS post-install configuration..."
    if sh "$POST_INSTALL_SCRIPT"; then
        echo "[$SERVICE_NAME] Post-install script completed successfully"
        touch "$MARKER_FILE"
        exit 0
    else
        echo "[$SERVICE_NAME] WARNING: Post-install script failed with exit code $?"
        exit 1
    fi
else
    echo "[$SERVICE_NAME] Post-install script not found"
    exit 1
fi